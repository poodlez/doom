<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>doom.c ‚Äî RIP AND TEAR</title>
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      margin: 0;
      background: #000;
      color: #9cff57;
      font-family: "Courier New", monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 24px;
      padding: 24px;
    }
    h1 {
      margin: 0;
      font-size: 2.5rem;
    }
    #game {
      max-width: 640px;
      width: 100%;
      height: auto;
      image-rendering: pixelated;
      border: 2px solid #9cff57;
      background: #111;
    }
    #controls {
      display: grid;
      grid-template-columns: repeat(3, minmax(80px, 1fr));
      gap: 12px;
      width: 100%;
      max-width: 420px;
    }
    button {
      padding: 12px;
      font: 600 16px "Courier New", monospace;
      background: #111;
      color: #9cff57;
      border: 2px solid #9cff57;
      cursor: pointer;
    }
    button:hover {
      background: #9cff57;
      color: #000;
    }
    footer {
      font-size: 0.85rem;
      color: #666;
    }
  </style>
</head>
<body>
  <header>
    <h1>ü©∏ doom.c ü©∏</h1>
  </header>
  <main>
    <img id="game" src="/doom.mjpeg?session=0" width="640" height="400" alt="Doom stream">
    <div id="controls">
      <span></span>
      <button data-key="key:w">W ‚Üë</button>
      <span></span>
      <button data-key="key:a">A ‚Üê</button>
      <button data-key="key:s">S ‚Üì</button>
      <button data-key="key:d">D ‚Üí</button>
      <button data-key="key:space">SPACE</button>
      <button data-key="key:Control_L">CTRL</button>
      <button data-key="key:Escape">ESC</button>
    </div>
  </main>
  <footer>
    <p>Heads-up: Inputs are naive POSTs. Be kind while we wire auth & rate limits.</p>
  </footer>
  <script>
    const sessionId = 0;
    const endpoint = (path) => `${path}?session=${sessionId}`;

    async function sendInput(payload) {
      try {
        await fetch(endpoint('/input'), {
          method: 'POST',
          body: payload,
        });
      } catch (err) {
        console.error('input failed', err);
      }
    }

    const KEY_MAP = {
      ' ': 'space',
      Space: 'space',
      Spacebar: 'space',
      ArrowUp: 'Up',
      ArrowDown: 'Down',
      ArrowLeft: 'Left',
      ArrowRight: 'Right',
      Control: 'Control_L',
      ControlLeft: 'Control_L',
      ControlRight: 'Control_R',
      Escape: 'Escape',
      Esc: 'Escape',
      Enter: 'Return',
      Return: 'Return',
    };

    function normalizeKey(key) {
      if (!key) {
        return null;
      }
      if (KEY_MAP[key]) {
        return KEY_MAP[key];
      }
      if (key.length === 1) {
        return key.toLowerCase();
      }
      return null;
    }

    document.querySelectorAll('button[data-key]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const payload = btn.dataset.key;
        if (payload) {
          sendInput(payload);
        }
      });
    });

    document.addEventListener('keydown', (event) => {
      if (event.repeat) {
        return;
      }
      const normalized = normalizeKey(event.key);
      if (!normalized) {
        return;
      }
      event.preventDefault();
      sendInput(`key:${normalized}`);
    });
  </script>
</body>
</html>
