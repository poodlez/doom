<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>doom.c</title>
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      background: #000;
      color-scheme: dark;
    }

    body {
      font-family: "IBM Plex Mono", "Courier New", monospace;
      overflow: hidden;
    }

    #game {
      display: block;
      width: 100vw;
      height: 100vh;
      max-width: 100vw;
      max-height: 100vh;
      border: none;
      outline: none;
      background: #000;
      object-fit: contain;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <img id="game" src="/doom.mjpeg?session=0" width="640" height="400" alt="Live Doom gameplay stream" tabindex="0">

  <script>
    const sessionId = 0;
    const endpoint = (path) => `${path}?session=${sessionId}`;

    function sendInput(payload) {
      if (!payload) {
        return;
      }
      fetch(endpoint('/input'), {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain',
        },
        body: payload,
      }).then((res) => {
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
      }).catch((err) => {
        console.error('input failed', err);
      });
    }

    const KEY_NAME_MAP = {
      ' ': 'space',
      Space: 'space',
      Spacebar: 'space',
      ArrowUp: 'Up',
      ArrowDown: 'Down',
      ArrowLeft: 'Left',
      ArrowRight: 'Right',
      Control: 'Control_L',
      ControlLeft: 'Control_L',
      ControlRight: 'Control_R',
      Escape: 'Escape',
      Esc: 'Escape',
      Enter: 'Return',
      Return: 'Return',
      Tab: 'Tab',
    };

    const KEY_CODE_MAP = {
      KeyW: 'w',
      KeyA: 'a',
      KeyS: 's',
      KeyD: 'd',
      KeyQ: 'q',
      KeyE: 'e',
      ArrowUp: 'Up',
      ArrowDown: 'Down',
      ArrowLeft: 'Left',
      ArrowRight: 'Right',
      Space: 'space',
      Spacebar: 'space',
      ControlLeft: 'Control_L',
      ControlRight: 'Control_R',
      Escape: 'Escape',
      Enter: 'Return',
      NumpadEnter: 'Return',
    };

    function normalizeKeyboardEvent(event) {
      if (!event) {
        return null;
      }
      if (KEY_CODE_MAP[event.code]) {
        return KEY_CODE_MAP[event.code];
      }
      if (KEY_NAME_MAP[event.key]) {
        return KEY_NAME_MAP[event.key];
      }
      if (event.key && event.key.length === 1) {
        return event.key.toLowerCase();
      }
      return null;
    }

    const activeKeys = new Set();
    const gameEl = document.getElementById('game');

    window.addEventListener('load', () => {
      gameEl?.focus();
    });

    ['pointerdown', 'click'].forEach((evt) => {
      gameEl?.addEventListener(evt, () => gameEl.focus());
    });

    function sendKeyState(key, state) {
      if (!key || !state) {
        return;
      }
      sendInput(`key:${key}:${state}`);
    }

    document.addEventListener('keydown', (event) => {
      const normalized = normalizeKeyboardEvent(event);
      if (!normalized) {
        return;
      }
      if (event.repeat) {
        return;
      }
      event.preventDefault();
      activeKeys.add(normalized);
      sendKeyState(normalized, 'down');
    });

    document.addEventListener('keyup', (event) => {
      const normalized = normalizeKeyboardEvent(event);
      if (!normalized) {
        return;
      }
      event.preventDefault();
      if (activeKeys.has(normalized)) {
        activeKeys.delete(normalized);
      }
      sendKeyState(normalized, 'up');
    });

    window.addEventListener('blur', () => {
      if (activeKeys.size === 0) {
        return;
      }
      activeKeys.forEach((key) => sendKeyState(key, 'up'));
      activeKeys.clear();
    });
  </script>
</body>
</html>
